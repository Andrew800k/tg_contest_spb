<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>–ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞</title>
  <script type="module" src="config.js"></script>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lottie-web/5.9.6/lottie.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>
  <style>
    /* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚Äî —Ü–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –≤—Å—ë */
    body {
      background-color: #ffffff !important;
      color: #000000 !important;
      margin: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-family: Arial, sans-serif;
      overflow: hidden;
    }
    /* –¢—ë–º–Ω–∞—è —Ç–µ–º–∞ */
    @media (prefers-color-scheme: dark) {
      body {
        background-color: #1e1e1e !important;
        color: #ffffff !important;
      }
    }

    /* –ö–∞–ø—á–∞ */
    #captcha-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 20px;
      padding: 20px;
    }
    #captcha-instruction {
      font-size: clamp(16px, 4vw, 22px);
      font-weight: bold;
      margin-bottom: 10px;
    }
    #captcha-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      max-width: 280px;
      width: 100%;
    }
    .captcha-btn {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      border: none;
      border-radius: 12px;
      color: white;
      font-size: clamp(24px, 6vw, 36px);
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(0,0,0,0.2);
      user-select: none;
      -webkit-tap-highlight-color: transparent;
    }
    .captcha-btn:active {
      transform: scale(0.95);
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }
    .captcha-btn.correct {
      background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
      animation: pulse 0.3s ease;
    }
    .captcha-btn.wrong {
      background: linear-gradient(135deg, #eb3349 0%, #f45c43 100%);
      animation: shake 0.3s ease;
    }
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    #captcha-progress {
      font-size: clamp(14px, 3vw, 18px);
      color: inherit;
      opacity: 0.8;
    }
    #captcha-sequence {
      font-size: clamp(18px, 5vw, 28px);
      margin: 10px 0;
      padding: 10px;
      background: rgba(0,0,0,0.05);
      border-radius: 12px;
      min-height: 50px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    @media (prefers-color-scheme: dark) {
      #captcha-sequence {
        background: rgba(255,255,255,0.05);
      }
    }

    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ */
    #animation-wrapper {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 60vh;
      width: 100%;
    }
    #animation-container {
      width: 55vw;
      max-width: 400px;
      min-width: 220px;
      display: none;
    }
    /* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ */
    .result-container {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 80%;
      max-width: 500px;
      height: 20vh;
    }
    /* –ê–¥–∞–ø—Ç–∏–≤–Ω—ã–π —Ç–µ–∫—Å—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ */
    #status {
      font-size: clamp(18px, 4vw, 28px);
      color: inherit !important;
      opacity: 0;
      transition: opacity 0.8s ease-in-out;
      width: 100%;
      text-align: center;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
  </style>
</head>
<body>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞–ø—á–∏ -->
  <div id="captcha-container" style="display: none;">
    <div id="captcha-instruction">–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫–∏ –ø–æ –ø–æ—Ä—è–¥–∫—É:</div>
    <div id="captcha-sequence"></div>
    <div id="captcha-buttons"></div>
    <div id="captcha-progress"></div>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ -->
  <div id="animation-wrapper">
    <div id="animation-container"></div>
  </div>

  <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ -->
  <div class="result-container">
    <div id="status"></div>
  </div>

  <script type="module">
    import CONFIG from './config.js';

    document.addEventListener("DOMContentLoaded", () => {
      if (window.Telegram && Telegram.WebApp && Telegram.WebApp.initDataUnsafe && Telegram.WebApp.initDataUnsafe.user) {

        Telegram.WebApp.ready();
        const initDataUnsafe = Telegram.WebApp.initDataUnsafe;
        const telegramId = initDataUnsafe.user.id;

        const urlParams = new URLSearchParams(window.location.search);
        const startAppParam = urlParams.get("startapp") ||
                              urlParams.get("startApp") ||
                              initDataUnsafe.start_param ||
                              null;

        if (urlParams.get("web_app_request_write_access") === "1") {
          Telegram.WebApp.requestWriteAccess();
        }

        const animationContainer = document.getElementById("animation-container");
        const anim = lottie.loadAnimation({
          container: animationContainer,
          renderer: "svg",
          loop: true,
          autoplay: false,
          path: "cat.json"
        });

        // –§—É–Ω–∫—Ü–∏—è –∫–∞–ø—á–∏ - –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫–∏ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ
        function showCaptcha(onSuccess) {
          const captchaContainer = document.getElementById("captcha-container");
          const sequenceEl = document.getElementById("captcha-sequence");
          const buttonsEl = document.getElementById("captcha-buttons");
          const progressEl = document.getElementById("captcha-progress");

          // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—É—é –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å –∏–∑ —ç–º–æ–¥–∑–∏
          const emojis = ["üéØ", "üé™", "üé®", "üé≠", "üé¨", "üéÆ"];
          const shuffled = emojis.sort(() => Math.random() - 0.5);
          const sequence = shuffled.slice(0, 4); // 4 –∫–Ω–æ–ø–∫–∏
          const buttons = [...sequence].sort(() => Math.random() - 0.5); // –ü–µ—Ä–µ–º–µ—à–∏–≤–∞–µ–º –¥–ª—è –ø–æ–∫–∞–∑–∞
          
          let currentStep = 0;
          let attempts = 3;

          // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å
          sequenceEl.innerHTML = sequence.map((e, i) => 
            `<span style="font-size: 28px; margin: 0 5px;">${i < currentStep ? '‚úÖ' : e}</span>`
          ).join('');
          
          // –°–æ–∑–¥–∞–µ–º –∫–Ω–æ–ø–∫–∏
          buttonsEl.innerHTML = '';
          buttons.forEach(emoji => {
            const btn = document.createElement('button');
            btn.className = 'captcha-btn';
            btn.textContent = emoji;
            btn.onclick = () => handleClick(emoji, btn);
            buttonsEl.appendChild(btn);
          });

          progressEl.textContent = `–û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: ${attempts}`;
          captchaContainer.style.display = "flex";

          function handleClick(emoji, btnElement) {
            if (emoji === sequence[currentStep]) {
              // –ü—Ä–∞–≤–∏–ª—å–Ω–æ!
              btnElement.classList.add('correct');
              Telegram.WebApp.HapticFeedback.impactOccurred("light");
              currentStep++;
              
              sequenceEl.innerHTML = sequence.map((e, i) => 
                `<span style="font-size: 28px; margin: 0 5px;">${i < currentStep ? '‚úÖ' : e}</span>`
              ).join('');

              if (currentStep === sequence.length) {
                // –ö–∞–ø—á–∞ –ø—Ä–æ–π–¥–µ–Ω–∞!
                Telegram.WebApp.HapticFeedback.notificationOccurred("success");
                confetti({ particleCount: 50, spread: 60, origin: { y: 0.6 } });
                setTimeout(() => onSuccess(), 500);
              }
            } else {
              // –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ!
              btnElement.classList.add('wrong');
              Telegram.WebApp.HapticFeedback.notificationOccurred("error");
              attempts--;
              
              setTimeout(() => btnElement.classList.remove('wrong'), 300);

              if (attempts <= 0) {
                // –ü–æ–ø—ã—Ç–∫–∏ –∑–∞–∫–æ–Ω—á–∏–ª–∏—Å—å - —Å–±—Ä–æ—Å
                progressEl.textContent = "‚ùå –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑...";
                setTimeout(() => {
                  currentStep = 0;
                  attempts = 3;
                  showCaptcha(onSuccess);
                }, 1500);
              } else {
                progressEl.textContent = `–û—Å—Ç–∞–ª–æ—Å—å –ø–æ–ø—ã—Ç–æ–∫: ${attempts}`;
              }
            }
          }
        }

        // –°–ù–ê–ß–ê–õ–ê –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–ø—á—É, –ü–û–¢–û–ú –∞–Ω–∏–º–∞—Ü–∏—é + –ø—Ä–æ–≤–µ—Ä–∫—É
        showCaptcha(() => {
          // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –ø—Ä–æ—Ö–æ–∂–¥–µ–Ω–∏—è –∫–∞–ø—á–∏
          document.getElementById("captcha-container").style.display = "none";
          animationContainer.style.display = "block";
          anim.play();
          checkAccess(startAppParam);
        });

        async function checkAccess(startAppParam) {
          const statusEl = document.getElementById("status");
          if (!telegramId) {
            statusEl.innerText = "–û—à–∏–±–∫–∞: Telegram ID –Ω–µ –ø–æ–ª—É—á–µ–Ω!";
            statusEl.style.opacity = "1";
            return;
          }

          const user = Telegram.WebApp.initDataUnsafe.user;
          const payload = {
            telegramId,
            startAppParam,
            username: user.username || null,
            firstName: user.first_name || null,
            lastName: user.last_name || null,
            initData: Telegram.WebApp.initData  // ‚Üê –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
          };

          const msgs = [
            "üîç –°–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ‚Ä¶",
            "ü§î –°—á–∏—Ç–∞–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤‚Ä¶",
            "üîÑ –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–ø–∏—Å–∫–∏‚Ä¶",
            "‚è≥ –ï—â—ë –æ–¥–Ω–∞ –ø–æ–ø—ã—Ç–∫–∞‚Ä¶",
            "üöÄ –ó–∞–≤–µ—Ä—à–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É‚Ä¶"
          ];

          let attempt = 0, success = false, backoff = 500, data;
          while (attempt < 5 && !success) {
            statusEl.innerHTML = msgs[attempt];
            statusEl.style.opacity = "1";
            try {
              const res = await fetch(CONFIG.END_POINT, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload)
              });
              if (!res.ok) throw new Error(`–°—Ç–∞—Ç—É—Å ${res.status}`);
              data = await res.json();
              success = true;
            } catch (e) {
              attempt++;
              if (attempt < 5) {
                await new Promise(r => setTimeout(r, backoff + Math.random()*200));
                backoff *= 2;
              } else {
                statusEl.innerHTML = "‚è≥ –û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–∑–∂–µ.";
                return;
              }
            }
          }

          // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é
          anim.stop();
          animationContainer.style.display = "none";

          if (data.status === "finished") {
            statusEl.innerHTML = "–ö–æ–Ω–∫—É—Ä—Å –∑–∞–≤–µ—Ä—à—ë–Ω üîö";
          } else if (data.status === "allowed") {
            statusEl.innerHTML = "‚úÖ –£—Å–ª–æ–≤–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã";
            Telegram.WebApp.HapticFeedback.impactOccurred("medium");
            confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } });
          } else {
            statusEl.innerHTML = "‚ùå –£—Å–ª–æ–≤–∏—è –ø–æ–¥–ø–∏—Å–∫–∏ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã";
            Telegram.WebApp.HapticFeedback.notificationOccurred("error");
            confetti({
              particleCount: 80,
              spread: 60,
              startVelocity: -40,
              gravity: 1.2,
              origin: { y: -0.2 },
              colors: ['#ff0000', '#ff4444', '#cc0000']
            });
            statusEl.style.animation = "shake 0.3s ease-in-out 2";
          }
        }
      } else {
        document.body.innerHTML = `
          <div style="display:flex;align-items:center;justify-content:center;height:100vh;background:white;">
            <h1>–†–∞–∑—Ä–∞–±–æ—Ç–∫–∞ –±–æ—Ç–æ–≤ <a href="https://t.me/bots_space" target="_blank">t.me/bots_space</a></h1>
          </div>`;
      }
    });
  </script>

</body>
</html>
